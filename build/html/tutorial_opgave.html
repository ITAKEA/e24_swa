<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial opgave &mdash; ITA 2024 3. semester</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css?v=a5898925" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=9eb32ce0"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/scripts/sphinx-book-theme.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            SoftwareArkitektur
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduktion til SWA og Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_intro_1.html">2. Introduction til python (dag1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_intro_2.html">3. Python - Datastrukture</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_intro_4.html">4. Python funktioner</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_intro_3.html">5. Python modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduktion_til_rest_api.html">6. En introduktion til REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="flask.html">7. Flask API</a></li>
<li class="toctree-l1"><a class="reference internal" href="flask_2.html">8. Flask (dag 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="decorators.html">9. Python  - Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="oop_1.html">10. Python - OOP</a></li>
<li class="toctree-l1"><a class="reference internal" href="dokumentation.html">11. Dokumentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="orm.html">12. Object Relational Mapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_1.html">13. Softwaretests</a></li>
<li class="toctree-l1"><a class="reference internal" href="dag1.html">14. Mikroservices med python, docker og Azure</a></li>
<li class="toctree-l1"><a class="reference internal" href="swagger.html">15. Swagger API dokumentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="16.html">16. Sidste dag med undervisning (16)</a></li>
<li class="toctree-l1"><a class="reference internal" href="eksamensprojekt.html">17. Eksamens Projektperiode (17-24)</a></li>
<li class="toctree-l1"><a class="reference internal" href="auditional_exercises.html">18. Extra øvelser</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SoftwareArkitektur</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial opgave</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ITAKEA/e24_swa.git/blob/maintutorial_opgave.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial-opgave">
<h1>Tutorial opgave<a class="headerlink" href="#tutorial-opgave" title="Link to this heading"></a></h1>
<p>De næste 2 uger skal i arbejde med en del tutorials. De er alle som udgangspunkt forbundet til denne hoved tutorial
<a class="reference external" href="https://realpython.com/build-llm-rag-chatbot-with-langchain/#demo-an-llm-rag-chatbot-with-langchain-and-neo4j">Build an LLM RAG Chatbot With LangChain</a>. I selve undervisningspeiroderne kommer jeg til at gennemgå de forskellige værktøjer i bruger i disse tutorials. Dette er eksempelvis</p>
<p><strong>Inkluderede “sub”-Tutorial</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://realpython.com/chromadb-vector-database/">Embeddings and Vector Databases With ChromaDB</a></p></li>
<li><p><a class="reference external" href="https://realpython.com/practical-prompt-engineering/">Prompt Engineering: A Practical Example</a></p></li>
<li><p><a class="reference external" href="https://mlflow.org/docs/latest/llms/rag/notebooks/mlflow-e2e-evaluation.html">LLM RAG Evaluation with MLflow Example Notebook</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=DM65_JyGxCo">Docker Compose will BLOW your MIND!! (a tutorial)</a></p></li>
<li><p><a class="reference external" href="https://python.langchain.com/v0.1/docs/get_started/quickstart/">LangChain Quickstart Guide</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/playlist?list=PLfaIDFEXuae0gBSJ9T0w7cu7iJZbH3T31">Video: LangChain v0.1.0 Launch</a></p></li>
<li><p>Neo4J og graph databaser</p></li>
<li><p>CouchDB og vector databaser</p></li>
<li><p>Sqlite og relationelle databaser</p></li>
<li><p>Lanchain</p></li>
<li><p>RAG</p></li>
<li><p>Text embeddings</p></li>
</ul>
<section id="laeringsmal">
<h2>Læringsmål<a class="headerlink" href="#laeringsmal" title="Link to this heading"></a></h2>
<p>Følgende skal i både kunne forklare og vise hvordan i gør brug af:</p>
<ul class="simple">
<li><p>Hvad er LangChain og hvordan bruges det?</p></li>
<li><p>Hvad er Neo4j og hvordan bruges det?</p></li>
<li><p>Hvad er fodelene ved en ‘Graph Database’</p></li>
<li><p>Hvad er en Vectordatabase?</p></li>
<li><p>Hvad er tekst embeddings?</p></li>
<li><p>Læse og forstå documentation (langchain, neo4j, )</p></li>
<li><p>Forklar hvad en ‘chain’ er i langchan context.</p></li>
<li><p>Forstå hvad RAG står for og kunne forklare hvordan det bruges.</p></li>
<li><p>Forstå sammenhængen mellem LLM og VectorDB´s</p></li>
<li><p>Forstå:chat models, prompts, chains, and retrieval, agents.</p></li>
<li><p>Forstå asyncron netværkskommunikation</p></li>
<li><p>Forstå hvad docker og docker-compose</p></li>
</ul>
</section>
<section id="opgave-beskrivelse">
<h2>Opgave beskrivelse<a class="headerlink" href="#opgave-beskrivelse" title="Link to this heading"></a></h2>
<p>Denne uge skal i bruge på følgende opgave.  Den er udformet som en Tutorial, og selve koden (det i skal lave) kan i finde på Github. I kan teoretisk set være færdige med denne opgave i løbet af en lille time, hvis i bruger den færdigekode, kopy/paster lidt hist og her osv.</p>
<p>Det er dog ikke meningen med opgaven.</p>
<p><strong>Meningen er at i skal forstå alle elementer i opgaven på en måde så i vil kunne fortælle hvad der præcist sker i hvert step.</strong></p>
<p>Hvordan i kommer dertil er op til jer, og i må få alt den hjælp i behøver fra mig eller LLM´er etc.</p>
<p>Tip: I skal bruge 20 timer på denne opgave, hvis i bruger mindre har i brugt for lidt tid på den!</p>
<ul class="simple">
<li><p><a class="reference external" href="https://realpython.com/build-llm-rag-chatbot-with-langchain/#demo-an-llm-rag-chatbot-with-langchain-and-neo4j">Build an LLM RAG Chatbot With LangChain</a></p></li>
</ul>
<p>Under “Step 5: Deploy the LangChain Agent” skal i <strong>ikke</strong> følge artiklen, men istedet følge det som jeg har skrevet herunder. I artiklen bruger forfatteren “FastApi” og “Streamlit UI”. Jeg har herunder omskrevet artikel til at bruge Flask og Jupyter Notebook. Det passer bedre til det vi har arbejdet med i dette semester.</p>
</section>
<section id="step-5-deploy-the-langchain-agent">
<h2>Step 5: Deploy the LangChain Agent<a class="headerlink" href="#step-5-deploy-the-langchain-agent" title="Link to this heading"></a></h2>
<p>At long last, you have a functioning LangChain agent that serves as your hospital system chatbot. The last thing you need to do is get your chatbot in front of stakeholders. For this, you’ll deploy your chatbot as a Flask API endpoint and create a Jupyter Notebook to interact with the endpoint.</p>
<p>Before you get started, create two new folders called <code class="docutils literal notranslate"><span class="pre">chatbot_frontend/</span></code> and <code class="docutils literal notranslate"><span class="pre">tests/</span></code> in your project’s root directory. You’ll also need to add some additional files and folders to <code class="docutils literal notranslate"><span class="pre">chatbot_api/</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>./
│
├── chatbot_api/
│   │
│   ├── src/
│   │   │
│   │   ├── agents/
│   │   │   └── hospital_rag_agent.py
│   │   │
│   │   ├── chains/
│   │   │   ├── hospital_cypher_chain.py
│   │   │   └── hospital_review_chain.py
│   │   │
│   │   ├── models/
│   │   │   └── hospital_rag_query.py
│   │   │
│   │   ├── tools/
│   │   │   └── wait_times.py
│   │   │
│   │   ├── utils/
│   │   │   └── async_utils.py
│   │   │
│   │   ├── entrypoint.sh
│   │   └── main.py
│   │
│   ├── Dockerfile
│   └── pyproject.toml
│
├── chatbot_frontend/
│   │
│   ├── src/
│   │   ├── entrypoint.sh
│   │   └── notebook.ipynb
│   │
│   ├── Dockerfile
│   └── pyproject.toml
│
├── hospital_neo4j_etl/
│   │
│   ├── src/
│   │   ├── entrypoint.sh
│   │   └── hospital_bulk_csv_write.py
│   │
│   ├── Dockerfile
│   └── pyproject.toml
│
├── tests/
│   ├── async_agent_requests.py
│   └── sync_agent_requests.py
│
├── .env
└── docker-compose.yml
</pre></div>
</div>
<p>You need the new files in <code class="docutils literal notranslate"><span class="pre">chatbot_api</span></code> to build your Flask app, and <code class="docutils literal notranslate"><span class="pre">tests/</span></code> has two scripts to demonstrate the power of making asynchronous requests to your agent. Lastly, <code class="docutils literal notranslate"><span class="pre">chatbot_frontend/</span></code> has the code for the Jupyter Notebook that’ll interface with your chatbot. You’ll start by creating a Flask application to serve your agent.</p>
<section id="serve-the-agent-with-flask">
<h3>Serve the Agent With Flask<a class="headerlink" href="#serve-the-agent-with-flask" title="Link to this heading"></a></h3>
<p>You’ll serve your agent through a POST request, so the first step is to define what data you expect to get in the request body and what data the request returns. Flask uses marshmallow library for object serialization and deserialization:</p>
<section id="chatbot-api-src-models-hospital-rag-query-py">
<h4>chatbot_api/src/models/hospital_rag_query.py<a class="headerlink" href="#chatbot-api-src-models-hospital-rag-query-py" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span>

<span class="k">class</span> <span class="nc">HospitalQueryInput</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HospitalQueryOutput</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">()</span>
    <span class="n">intermediate_steps</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">())</span>
</pre></div>
</div>
<p>In this script, you define marshmallow schemas <code class="docutils literal notranslate"><span class="pre">HospitalQueryInput</span></code> and <code class="docutils literal notranslate"><span class="pre">HospitalQueryOutput</span></code>. <code class="docutils literal notranslate"><span class="pre">HospitalQueryInput</span></code> is used to verify that the POST request body includes a <code class="docutils literal notranslate"><span class="pre">text</span></code> field, representing the query your chatbot responds to. <code class="docutils literal notranslate"><span class="pre">HospitalQueryOutput</span></code> verifies the response body sent back to your user includes <code class="docutils literal notranslate"><span class="pre">input</span></code>, <code class="docutils literal notranslate"><span class="pre">output</span></code>, and <code class="docutils literal notranslate"><span class="pre">intermediate_step</span></code> fields.</p>
<p>Next, the driving logic for your chatbot API is in <code class="docutils literal notranslate"><span class="pre">chatbot_api/src/main.py</span></code>:</p>
</section>
<section id="chatbot-api-src-main-py">
<h4>chatbot_api/src/main.py<a class="headerlink" href="#chatbot-api-src-main-py" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">agents.hospital_rag_agent</span> <span class="kn">import</span> <span class="n">hospital_rag_agent_executor</span>
<span class="kn">from</span> <span class="nn">models.hospital_rag_query</span> <span class="kn">import</span> <span class="n">HospitalQueryInput</span><span class="p">,</span> <span class="n">HospitalQueryOutput</span>
<span class="kn">from</span> <span class="nn">utils.async_utils</span> <span class="kn">import</span> <span class="n">async_retry</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_status</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">})</span>

<span class="nd">@async_retry</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">invoke_agent_with_retry</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retry the agent if a tool fails to run.</span>

<span class="sd">    This can help when there are intermittent connection issues</span>
<span class="sd">    to external APIs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">hospital_rag_agent_executor</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/hospital-rag-agent&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">query_hospital_agent</span><span class="p">():</span>
    <span class="n">request_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="n">HospitalQueryInput</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span>
    <span class="n">query_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">invoke_agent_with_retry</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>

    <span class="n">output_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">query_response</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span>
        <span class="s2">&quot;intermediate_steps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">query_response</span><span class="p">[</span><span class="s2">&quot;intermediate_steps&quot;</span><span class="p">]]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">HospitalQueryOutput</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output_data</span><span class="p">))</span>
</pre></div>
</div>
<p>You import Flask, your agent executor, the marshmallow schemas you created for the POST request, and <code class="docutils literal notranslate"><span class="pre">&#64;async_retry</span></code>. Then you instantiate a Flask object and define <code class="docutils literal notranslate"><span class="pre">invoke_agent_with_retry()</span></code>, a function that runs your agent asynchronously. The <code class="docutils literal notranslate"><span class="pre">&#64;async_retry</span></code> decorator above <code class="docutils literal notranslate"><span class="pre">invoke_agent_with_retry()</span></code> ensures the function will be retried ten times with a delay of one second before failing.</p>
<p>Lastly, you define <code class="docutils literal notranslate"><span class="pre">query_hospital_agent()</span></code>, which serves POST requests to your agent at <code class="docutils literal notranslate"><span class="pre">/hospital-rag-agent</span></code>. This function extracts the <code class="docutils literal notranslate"><span class="pre">text</span></code> field from the request body, passes it to the agent, and returns the agent’s response to the user.</p>
<p>You’ll serve this API with Docker and you’ll want to define the following entrypoint file to run inside the container:</p>
</section>
<section id="chatbot-api-src-entrypoint-sh">
<h4>chatbot_api/src/entrypoint.sh<a class="headerlink" href="#chatbot-api-src-entrypoint-sh" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1"># Run any setup steps or pre-processing tasks here</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting hospital RAG Flask service...&quot;</span>

<span class="c1"># Start the main application</span>
python<span class="w"> </span>main.py
</pre></div>
</div>
<p>The main driver file for Flask app looks like this:</p>
</section>
<section id="id1">
<h4>chatbot_api/src/main.py<a class="headerlink" href="#id1" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chatbot_api/src/main.py</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</pre></div>
</div>
<p>The driving Dockerfile for your Flask app looks like this:</p>
</section>
<section id="chatbot-api-dockerfile">
<h4>chatbot_api/Dockerfile<a class="headerlink" href="#chatbot-api-dockerfile" title="Link to this heading"></a></h4>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># chatbot_api/Dockerfile</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>./src/<span class="w"> </span>/app

<span class="k">COPY</span><span class="w"> </span>./pyproject.toml<span class="w"> </span>/code/pyproject.toml
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>/code/.

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8000</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;entrypoint.sh&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This Dockerfile tells your container to use the <code class="docutils literal notranslate"><span class="pre">python:3.11-slim</span></code> distribution, copy the contents from <code class="docutils literal notranslate"><span class="pre">chatbot_api/src/</span></code> into the <code class="docutils literal notranslate"><span class="pre">/app</span></code> directory within the container, install the dependencies from <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, and run <code class="docutils literal notranslate"><span class="pre">entrypoint.sh</span></code>.</p>
<p>The last thing you’ll need to do is update the <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> file to include your Flask container:</p>
</section>
<section id="docker-compose-yml">
<h4>docker-compose.yml<a class="headerlink" href="#docker-compose-yml" title="Link to this heading"></a></h4>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hospital_neo4j_etl</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./hospital_neo4j_etl</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>

<span class="w">  </span><span class="nt">chatbot_api</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./chatbot_api</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hospital_neo4j_etl</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8000:8000&quot;</span>
</pre></div>
</div>
<p>To run the API, along with the ETL you built earlier, open a terminal and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>docker-compose<span class="w"> </span>up<span class="w"> </span>--build
</pre></div>
</div>
<p>If everything runs successfully, you’ll see a screen similar to the following at <code class="docutils literal notranslate"><span class="pre">http://localhost:8000</span></code>:</p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="create-a-interaction-interface-with-jupyter-notebook">
<h2>Create a Interaction Interface with Jupyter Notebook<a class="headerlink" href="#create-a-interaction-interface-with-jupyter-notebook" title="Link to this heading"></a></h2>
<p>Instead of using Streamlit, you’ll use a Jupyter Notebook to create a simple front-end to interface with the chatbot API. Here’s the code for your Jupyter Notebook (<code class="docutils literal notranslate"><span class="pre">chatbot_frontend/src/notebook.ipynb</span></code>):</p>
<section id="chatbot-frontend-src-notebook-ipynb">
<h3>chatbot_frontend/src/notebook.ipynb<a class="headerlink" href="#chatbot-frontend-src-notebook-ipynb" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding: utf-8</span>

<span class="c1"># In[1]:</span>


<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># Set the URL for your chatbot API</span>
<span class="n">CHATBOT_URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000/hospital-rag-agent&quot;</span>

<span class="k">def</span> <span class="nf">ask_question</span><span class="p">(</span><span class="n">question</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">question</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">CHATBOT_URL</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;An error occurred while processing your message.&quot;</span><span class="p">,</span> <span class="p">[]</span>

<span class="c1"># Function to display chat interaction</span>
<span class="k">def</span> <span class="nf">chat</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">IPython.display</span> <span class="k">as</span> <span class="nn">display</span>
    <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>
    
    <span class="n">input_box</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;Ask your question here...&#39;</span><span class="p">)</span>
    <span class="n">output_area</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">on_submit</span><span class="p">(</span><span class="n">sender</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">output_area</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User: </span><span class="si">{</span><span class="n">input_box</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">ask_question</span><span class="p">(</span><span class="n">input_box</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intermediate Steps: </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">input_box</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="n">input_box</span><span class="o">.</span><span class="n">on_submit</span><span class="p">(</span><span class="n">on_submit</span><span class="p">)</span>
    <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">input_box</span><span class="p">,</span> <span class="n">output_area</span><span class="p">)</span>

<span class="c1"># Start the chat</span>
<span class="n">chat</span><span class="p">()</span>
</pre></div>
</div>
<p>Create an entrypoint file to run Jupyter Notebook:</p>
</section>
<section id="chatbot-frontend-src-entrypoint-sh">
<h3>chatbot_frontend/src/entrypoint.sh<a class="headerlink" href="#chatbot-frontend-src-entrypoint-sh" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1"># Run any setup steps or pre-processing tasks here</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting hospital chatbot frontend...&quot;</span>

<span class="c1"># Run the Jupyter Notebook</span>
jupyter<span class="w"> </span>notebook<span class="w"> </span>--ip<span class="o">=</span><span class="m">0</span>.0.0.0<span class="w"> </span>--port<span class="o">=</span><span class="m">8888</span><span class="w"> </span>--no-browser<span class="w"> </span>--allow-root
</pre></div>
</div>
<p>And finally, the Docker file to create an image for the frontend:</p>
</section>
<section id="chatbot-frontend-dockerfile">
<h3>chatbot_frontend/Dockerfile<a class="headerlink" href="#chatbot-frontend-dockerfile" title="Link to this heading"></a></h3>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">COPY</span><span class="w"> </span>./src/<span class="w"> </span>/app

<span class="k">COPY</span><span class="w"> </span>./pyproject.toml<span class="w"> </span>/code/pyproject.toml
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>/code/.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>jupyter

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;entrypoint.sh&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Update the <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> file to include your <code class="docutils literal notranslate"><span class="pre">chatbot_frontend</span></code> service:</p>
<section id="id2">
<h4>docker-compose.yml<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hospital_neo4j_etl</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./hospital_neo4j_etl</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>

<span class="w">  </span><span class="nt">chatbot_api</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./chatbot_api</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hospital_neo4j_etl</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8000:8000&quot;</span>

<span class="w">  </span><span class="nt">chatbot_frontend</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./chatbot_frontend</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chatbot_api</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8888:8888&quot;</span>
</pre></div>
</div>
<p>Finally, open a terminal and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>docker-compose<span class="w"> </span>up<span class="w"> </span>--build
</pre></div>
</div>
<p>Once everything builds and runs, you can access the Jupyter Notebook interface at <code class="docutils literal notranslate"><span class="pre">http://localhost:8888/</span></code> to begin chatting with your chatbot:</p>
<p>You’ve now built a fully functioning hospital system chatbot end-to-end with Flask and Jupyter Notebook. Take some time to ask it questions, see the kinds of questions it’s good at answering, find out where it fails, and think about how you might improve it with better prompting or data. You can start by making sure the example questions are correctly answered.</p>
</section>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading"></a></h2>
<p>Congratulations on completing this in-depth tutorial!</p>
<p>You’ve successfully designed, built, and served a RAG LangChain chatbot that answers questions about a fake hospital system. There are certainly many ways you can improve the chatbot you built in this tutorial, but you now have a sound understanding of how to integrate LangChain with your own data, giving you the creative freedom to build all kinds of custom chatbots.</p>
<p>In this tutorial, you’ve learned how to:</p>
<ul class="simple">
<li><p>Use LangChain to build personalized chatbots.</p></li>
<li><p>Create a chatbot for a fake hospital system by aligning with business requirements and leveraging available data.</p></li>
<li><p>Consider the implementation of graph databases in your chatbot design.</p></li>
<li><p>Set up a Neo4j AuraDB instance for your project.</p></li>
<li><p>Develop a RAG chatbot capable of fetching both structured and unstructured data from Neo4j.</p></li>
<li><p>Deploy your chatbot using Flask API and Jupyter Notebook.</p></li>
</ul>
<p>You can find the complete source code and data for this project, in the supporting materials, which you can download using the link below:</p>
<hr class="docutils" />
<ul class="simple">
<li><p>til denne tutorial er der en del relaterede artikler, som det vil være godt (i det mindste) at skimme igennem.</p>
<ul>
<li><p><a class="reference external" href="https://realpython.com/practical-prompt-engineering/">Prompt Engineering: A Practical Example</a></p></li>
<li><p><a class="reference external" href="https://realpython.com/chromadb-vector-database/">Embeddings and Vector Databases With ChromaDB</a></p></li>
</ul>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Claus Bove.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>